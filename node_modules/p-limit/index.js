'use strict';
<<<<<<< HEAD
<<<<<<< HEAD
const pTry = require('p-try');

=======
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
=======
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
module.exports = concurrency => {
	if (concurrency < 1) {
		throw new TypeError('Expected `concurrency` to be a number from 1 and up');
	}

	const queue = [];
	let activeCount = 0;

	const next = () => {
		activeCount--;

		if (queue.length > 0) {
			queue.shift()();
		}
	};

	return fn => new Promise((resolve, reject) => {
		const run = () => {
			activeCount++;

<<<<<<< HEAD
<<<<<<< HEAD
			pTry(() => fn()).then(
=======
			fn().then(
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
=======
			fn().then(
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
				val => {
					resolve(val);
					next();
				},
				err => {
					reject(err);
					next();
				}
			);
		};

		if (activeCount < concurrency) {
			run();
		} else {
			queue.push(run);
		}
	});
};
