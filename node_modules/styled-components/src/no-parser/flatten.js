// @flow
import isPlainObject from 'is-plain-object'
import type { Interpolation } from '../types'
import _flatten, { objToCss } from '../utils/flatten'

<<<<<<< HEAD
const isRuleSet = (interpolation: Interpolation): boolean =>
  !!(
    interpolation &&
    Array.isArray(interpolation) &&
    interpolation.length > 0 &&
    interpolation[0] &&
    Array.isArray(interpolation[0])
  )

const flatten = (
  chunks: Array<Interpolation>,
  executionContext: ?Object,
): Array<Interpolation> => {
=======
const isRuleSet = (interpolation: Interpolation): boolean => !!(
  interpolation &&
  Array.isArray(interpolation) &&
  interpolation.length > 0 &&
  interpolation[0] &&
  Array.isArray(interpolation[0])
)

const flatten = (chunks: Array<Interpolation>, executionContext: ?Object): Array<Interpolation> => {
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
  /* Fall back to old flattener for non-rule-set chunks */
  if (!isRuleSet(chunks)) {
    return _flatten(chunks, executionContext)
  }

  return chunks.reduce(
<<<<<<< HEAD
    (
      ruleSet: Array<Interpolation>,
      chunk: ?Interpolation,
    ): Array<Interpolation> => {
=======
    (ruleSet: Array<Interpolation>, chunk: ?Interpolation): Array<Interpolation> => {
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
      if (!Array.isArray(chunk)) {
        return ruleSet
      }

      let appendChunks = []

      const newChunk = chunk.reduce(
<<<<<<< HEAD
        (
          rules: Array<Interpolation>,
          rule: ?Interpolation,
        ): Array<Interpolation> => {
          /* Remove falsey values */
          if (
            rule === undefined ||
            rule === null ||
            rule === false ||
            rule === ''
          ) {
=======
        (rules: Array<Interpolation>, rule: ?Interpolation): Array<Interpolation> => {
          /* Remove falsey values */
          if (rule === undefined || rule === null || rule === false || rule === '') {
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
            return rules
          }

          /* Flatten nested rule set */
          if (isRuleSet(rule)) {
            // $FlowFixMe Don't know what's wrong here
            appendChunks = [...appendChunks, ...flatten(rule, executionContext)]
            return rules
          }

          /* Stringify unexpected array */
          if (Array.isArray(rule)) {
            return [...rules, ..._flatten(rule, executionContext)]
          }

          /* Either execute or defer the function */
          if (typeof rule === 'function') {
            if (executionContext) {
              const res = rule(executionContext)

              if (isRuleSet(res)) {
<<<<<<< HEAD
                appendChunks = [
                  ...appendChunks,
                  // $FlowFixMe Don't know what's wrong here
                  ...flatten(res, executionContext),
                ]
=======
                // $FlowFixMe Don't know what's wrong here
                appendChunks = [...appendChunks, ...flatten(res, executionContext)]
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
                return rules
              }

              /* Flatten non-ruleset values */
              return [...rules, ...flatten([res], executionContext)]
            } else {
              return [...rules, rule]
            }
          }

          /* Handle other components */
<<<<<<< HEAD
          if (
            typeof rule === 'object' &&
            rule.hasOwnProperty('styledComponentId')
          ) {
            return [...rules, `.${rule.styledComponentId}`]
          }
=======
          if (typeof rule === 'object' && rule.hasOwnProperty('styledComponentId')) return [...rules, `.${rule.styledComponentId}`]
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b

          /* Convert object to css string */
          if (typeof rule === 'object' && isPlainObject(rule)) {
            return [...rules, objToCss(rule)]
          }

          return [...rules, rule.toString()]
        },
        [],
      )

      if (executionContext) {
        const newChunkStr = newChunk.join('')
        if (appendChunks.length) {
          return [...ruleSet, newChunkStr, ...appendChunks]
        }

        return [...ruleSet, newChunkStr]
      }

      return [...ruleSet, newChunk, ...appendChunks]
<<<<<<< HEAD
    },
    [],
=======
    }, [],
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
  )
}

export default flatten
