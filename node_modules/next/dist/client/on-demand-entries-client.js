<<<<<<< HEAD
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
=======
'use strict';
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b

Object.defineProperty(exports, "__esModule", {
  value: true
});
<<<<<<< HEAD
exports.default = void 0;

var _promise = _interopRequireDefault(require("@babel/runtime/core-js/promise"));

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _router = _interopRequireDefault(require("../lib/router"));

var _unfetch = _interopRequireDefault(require("unfetch"));

/* global location */
var _window = window,
    assetPrefix = _window.__NEXT_DATA__.assetPrefix;

var _default = function _default() {
  _router.default.ready(function () {
    _router.default.router.events.on('routeChangeComplete', ping);
  });

  function ping() {
    return _ping.apply(this, arguments);
  }

  function _ping() {
    _ping = (0, _asyncToGenerator2.default)(
    /*#__PURE__*/
    _regenerator.default.mark(function _callee() {
      var url, res, payload, pageRes;
      return _regenerator.default.wrap(function _callee$(_context) {
=======

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _router = require('../lib/router');

var _router2 = _interopRequireDefault(_router);

var _unfetch = require('unfetch');

var _unfetch2 = _interopRequireDefault(_unfetch);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/* global location */

exports.default = function () {
  var ping = function () {
    var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee() {
      var url, res, payload, pageRes;
      return _regenerator2.default.wrap(function _callee$(_context) {
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              _context.prev = 0;
<<<<<<< HEAD
              url = "".concat(assetPrefix, "/_next/on-demand-entries-ping?page=").concat(_router.default.pathname);
              _context.next = 4;
              return (0, _unfetch.default)(url, {
                credentials: 'omit'
=======
              url = '/_next/on-demand-entries-ping?page=' + _router2.default.pathname;
              _context.next = 4;
              return (0, _unfetch2.default)(url, {
                credentials: 'same-origin'
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
              });

            case 4:
              res = _context.sent;
              _context.next = 7;
              return res.json();

            case 7:
              payload = _context.sent;

              if (!payload.invalid) {
                _context.next = 13;
                break;
              }

              _context.next = 11;
<<<<<<< HEAD
              return (0, _unfetch.default)(location.href, {
                credentials: 'omit'
=======
              return (0, _unfetch2.default)(location.href, {
                credentials: 'same-origin'
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
              });

            case 11:
              pageRes = _context.sent;

              if (pageRes.status === 200) {
                location.reload();
              }

            case 13:
              _context.next = 18;
              break;

            case 15:
              _context.prev = 15;
<<<<<<< HEAD
              _context.t0 = _context["catch"](0);
              console.error("Error with on-demand-entries-ping: ".concat(_context.t0.message));

            case 18:
            case "end":
=======
              _context.t0 = _context['catch'](0);

              console.error('Error with on-demand-entries-ping: ' + _context.t0.message);

            case 18:
            case 'end':
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
              return _context.stop();
          }
        }
      }, _callee, this, [[0, 15]]);
    }));
<<<<<<< HEAD
    return _ping.apply(this, arguments);
  }

  var pingerTimeout;

  function runPinger() {
    return _runPinger.apply(this, arguments);
  }

  function _runPinger() {
    _runPinger = (0, _asyncToGenerator2.default)(
    /*#__PURE__*/
    _regenerator.default.mark(function _callee2() {
      return _regenerator.default.wrap(function _callee2$(_context2) {
=======

    return function ping() {
      return _ref.apply(this, arguments);
    };
  }();

  var runPinger = function () {
    var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2() {
      return _regenerator2.default.wrap(function _callee2$(_context2) {
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
        while (1) {
          switch (_context2.prev = _context2.next) {
            case 0:
              if (document.hidden) {
                _context2.next = 7;
                break;
              }

              _context2.next = 3;
              return ping();

            case 3:
              _context2.next = 5;
<<<<<<< HEAD
              return new _promise.default(function (resolve) {
=======
              return new _promise2.default(function (resolve) {
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
                pingerTimeout = setTimeout(resolve, 5000);
              });

            case 5:
              _context2.next = 0;
              break;

            case 7:
<<<<<<< HEAD
            case "end":
=======
            case 'end':
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
              return _context2.stop();
          }
        }
      }, _callee2, this);
    }));
<<<<<<< HEAD
    return _runPinger.apply(this, arguments);
  }
=======

    return function runPinger() {
      return _ref2.apply(this, arguments);
    };
  }();

  _router2.default.ready(function () {
    _router2.default.router.events.on('routeChangeComplete', ping);
  });

  var pingerTimeout = void 0;

>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b

  document.addEventListener('visibilitychange', function () {
    if (!document.hidden) {
      runPinger();
    } else {
      clearTimeout(pingerTimeout);
    }
  }, false);
<<<<<<< HEAD
=======

>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
  setTimeout(function () {
    runPinger().catch(function (err) {
      console.error(err);
    });
  }, 10000);
<<<<<<< HEAD
};

exports.default = _default;
=======
};
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
