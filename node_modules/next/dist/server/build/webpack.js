<<<<<<< HEAD
<<<<<<< HEAD
"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
=======
'use strict';
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
=======
'use strict';
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b

Object.defineProperty(exports, "__esModule", {
  value: true
});
<<<<<<< HEAD
<<<<<<< HEAD
exports.default = getBaseWebpackConfig;

var _stringify = _interopRequireDefault(require("@babel/runtime/core-js/json/stringify"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

var _keys = _interopRequireDefault(require("@babel/runtime/core-js/object/keys"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _map = _interopRequireDefault(require("@babel/runtime/core-js/map"));

var _path = _interopRequireWildcard(require("path"));

var _webpack = _interopRequireDefault(require("webpack"));

var _resolve = _interopRequireDefault(require("resolve"));

var _uglifyjsWebpackPlugin = _interopRequireDefault(require("uglifyjs-webpack-plugin"));

var _caseSensitivePathsWebpackPlugin = _interopRequireDefault(require("case-sensitive-paths-webpack-plugin"));

var _writeFileWebpackPlugin = _interopRequireDefault(require("write-file-webpack-plugin"));

var _friendlyErrorsWebpackPlugin = _interopRequireDefault(require("friendly-errors-webpack-plugin"));

var _core = require("@babel/core");

var _utils = require("./webpack/utils");

var _pagesPlugin = _interopRequireDefault(require("./plugins/pages-plugin"));

var _nextjsSsrImport = _interopRequireDefault(require("./plugins/nextjs-ssr-import"));

var _dynamicChunksPlugin = _interopRequireDefault(require("./plugins/dynamic-chunks-plugin"));

var _unlinkFilePlugin = _interopRequireDefault(require("./plugins/unlink-file-plugin"));

var _pagesManifestPlugin = _interopRequireDefault(require("./plugins/pages-manifest-plugin"));

var _buildManifestPlugin = _interopRequireDefault(require("./plugins/build-manifest-plugin"));

var presetItem = (0, _core.createConfigItem)(require('./babel/preset'), {
  type: 'preset'
});
var hotLoaderItem = (0, _core.createConfigItem)(require('react-hot-loader/babel'), {
  type: 'plugin'
});
var reactJsxSourceItem = (0, _core.createConfigItem)(require('@babel/plugin-transform-react-jsx-source'), {
  type: 'plugin'
});

var nextDir = _path.default.join(__dirname, '..', '..', '..');

var nextNodeModulesDir = _path.default.join(nextDir, 'node_modules');

var nextPagesDir = _path.default.join(nextDir, 'pages');

var defaultPages = ['_error.js', '_document.js', '_app.js'];
var interpolateNames = new _map.default(defaultPages.map(function (p) {
  return [_path.default.join(nextPagesDir, p), "dist/bundles/pages/".concat(p)];
}));

function babelConfig(dir, _ref) {
  var isServer = _ref.isServer,
      dev = _ref.dev;
  var mainBabelOptions = {
    cacheDirectory: true,
    presets: [],
    plugins: [dev && !isServer && hotLoaderItem, dev && reactJsxSourceItem].filter(Boolean)
  };

  var filename = _path.default.join(dir, 'filename.js');

  var externalBabelConfig = (0, _core.loadPartialConfig)({
    babelrc: true,
    filename: filename
  });

  if (externalBabelConfig && externalBabelConfig.babelrc) {
    // Log it out once
    if (!isServer) {
      console.log("> Using external babel configuration");
      console.log("> Location: \"".concat(externalBabelConfig.babelrc, "\""));
    }

    mainBabelOptions.babelrc = true;
  } else {
    mainBabelOptions.babelrc = false;
  } // Add our default preset if the no "babelrc" found.


  if (!mainBabelOptions.babelrc) {
    mainBabelOptions.presets.push(presetItem);
  }

  return mainBabelOptions;
}

function externalsConfig(dir, isServer) {
  var externals = [];

  if (!isServer) {
    return externals;
  }

  externals.push(function (context, request, callback) {
    (0, _resolve.default)(request, {
      basedir: dir,
      preserveSymlinks: true
    }, function (err, res) {
      if (err) {
        return callback();
      } // Default pages have to be transpiled


      if (res.match(/node_modules[/\\]next[/\\]dist[/\\]pages/)) {
        return callback();
      } // Webpack itself has to be compiled because it doesn't always use module relative paths


      if (res.match(/node_modules[/\\]webpack/)) {
        return callback();
      }

      if (res.match(/node_modules[/\\].*\.js$/)) {
        return callback(null, "commonjs ".concat(request));
      }

      callback();
    });
  });
  return externals;
}

function getBaseWebpackConfig(_x, _x2) {
  return _getBaseWebpackConfig.apply(this, arguments);
}

function _getBaseWebpackConfig() {
  _getBaseWebpackConfig = (0, _asyncToGenerator2.default)(
  /*#__PURE__*/
  _regenerator.default.mark(function _callee2(dir, _ref2) {
    var _ref2$dev, dev, _ref2$isServer, isServer, buildId, config, babelLoaderOptions, defaultLoaders, nodePathList, pagesEntries, totalPages, clientEntries, webpackConfig;

    return _regenerator.default.wrap(function _callee2$(_context2) {
      while (1) {
        switch (_context2.prev = _context2.next) {
          case 0:
            _ref2$dev = _ref2.dev, dev = _ref2$dev === void 0 ? false : _ref2$dev, _ref2$isServer = _ref2.isServer, isServer = _ref2$isServer === void 0 ? false : _ref2$isServer, buildId = _ref2.buildId, config = _ref2.config;
            babelLoaderOptions = babelConfig(dir, {
              dev: dev,
              isServer: isServer
            });
            defaultLoaders = {
              babel: {
                loader: 'babel-loader',
                options: babelLoaderOptions
              } // Support for NODE_PATH

            };
            nodePathList = (process.env.NODE_PATH || '').split(process.platform === 'win32' ? ';' : ':').filter(function (p) {
              return !!p;
            });
            _context2.next = 6;
            return (0, _utils.getPages)(dir, {
              dev: dev,
              isServer: isServer,
              pageExtensions: config.pageExtensions.join('|')
            });

          case 6:
            pagesEntries = _context2.sent;
            totalPages = (0, _keys.default)(pagesEntries).length;
            clientEntries = !isServer ? {
              'main.js': [dev && !isServer && _path.default.join(__dirname, '..', '..', 'client', 'webpack-hot-middleware-client'), dev && !isServer && _path.default.join(__dirname, '..', '..', 'client', 'on-demand-entries-client'), require.resolve("../../client/next".concat(dev ? '-dev' : ''))].filter(Boolean)
            } : {};
            webpackConfig = {
              devtool: dev ? 'cheap-module-source-map' : false,
              name: isServer ? 'server' : 'client',
              cache: true,
              target: isServer ? 'node' : 'web',
              externals: externalsConfig(dir, isServer),
              context: dir,
              // Kept as function to be backwards compatible
              entry: function () {
                var _entry = (0, _asyncToGenerator2.default)(
                /*#__PURE__*/
                _regenerator.default.mark(function _callee() {
                  return _regenerator.default.wrap(function _callee$(_context) {
                    while (1) {
                      switch (_context.prev = _context.next) {
                        case 0:
                          return _context.abrupt("return", (0, _objectSpread2.default)({}, clientEntries, pagesEntries));

                        case 1:
                        case "end":
                          return _context.stop();
                      }
                    }
                  }, _callee, this);
                }));

                return function entry() {
                  return _entry.apply(this, arguments);
                };
              }(),
              output: {
                path: _path.default.join(dir, config.distDir, isServer ? 'dist' : ''),
                // server compilation goes to `.next/dist`
                filename: '[name]',
                libraryTarget: 'commonjs2',
                // This saves chunks with the name given via require.ensure()
                chunkFilename: '[name]-[chunkhash].js',
                strictModuleExceptionHandling: true
              },
              performance: {
                hints: false
              },
              resolve: {
                extensions: ['.js', '.jsx', '.json'],
                modules: [nextNodeModulesDir, 'node_modules'].concat((0, _toConsumableArray2.default)(nodePathList)),
                alias: {
                  next: nextDir,
                  // React already does something similar to this.
                  // But if the user has react-devtools, it'll throw an error showing that
                  // we haven't done dead code elimination (via uglifyjs).
                  // We purposly do not uglify React code to save the build time.
                  // (But it didn't increase the overall build size)
                  // Here we are doing an exact match with '$'
                  // So, you can still require nested modules like `react-dom/server`
                  react$: dev ? 'react/cjs/react.development.js' : 'react/cjs/react.production.min.js',
                  'react-dom$': dev ? 'react-dom/cjs/react-dom.development.js' : 'react-dom/cjs/react-dom.production.min.js'
                }
              },
              resolveLoader: {
                modules: [nextNodeModulesDir, 'node_modules', _path.default.join(__dirname, 'loaders')].concat((0, _toConsumableArray2.default)(nodePathList))
              },
              module: {
                rules: [dev && !isServer && {
                  test: /\.(js|jsx)$/,
                  loader: 'hot-self-accept-loader',
                  include: [_path.default.join(dir, 'pages'), nextPagesDir],
                  options: {
                    extensions: /\.(js|jsx)$/
                  }
                }, {
                  test: /\.(js|jsx)$/,
                  include: [dir],
                  exclude: /node_modules/,
                  use: defaultLoaders.babel
                }].filter(Boolean)
              },
              plugins: [new _webpack.default.IgnorePlugin(/(precomputed)/, /node_modules.+(elliptic)/), dev && new _webpack.default.NoEmitOnErrorsPlugin(), dev && !isServer && new _friendlyErrorsWebpackPlugin.default(), dev && new _webpack.default.NamedModulesPlugin(), dev && !isServer && new _webpack.default.HotModuleReplacementPlugin(), // Hot module replacement
              dev && new _unlinkFilePlugin.default(), dev && new _caseSensitivePathsWebpackPlugin.default(), // Since on macOS the filesystem is case-insensitive this will make sure your path are case-sensitive
              dev && new _webpack.default.LoaderOptionsPlugin({
                options: {
                  context: dir,
                  customInterpolateName: function customInterpolateName(url, name, opts) {
                    return interpolateNames.get(this.resourcePath) || url;
                  }
                }
              }), dev && new _writeFileWebpackPlugin.default({
                exitOnErrors: false,
                log: false,
                // required not to cache removed files
                useHashIndex: false
              }), !dev && new _webpack.default.IgnorePlugin(/react-hot-loader/), !isServer && !dev && new _uglifyjsWebpackPlugin.default({
                exclude: /react\.js/,
                parallel: true,
                sourceMap: false,
                uglifyOptions: {
                  compress: {
                    arrows: false,
                    booleans: false,
                    collapse_vars: false,
                    comparisons: false,
                    computed_props: false,
                    hoist_funs: false,
                    hoist_props: false,
                    hoist_vars: false,
                    if_return: false,
                    inline: false,
                    join_vars: false,
                    keep_infinity: true,
                    loops: false,
                    negate_iife: false,
                    properties: false,
                    reduce_funcs: false,
                    reduce_vars: false,
                    sequences: false,
                    side_effects: false,
                    switches: false,
                    top_retain: false,
                    toplevel: false,
                    typeofs: false,
                    unused: false,
                    conditionals: true,
                    dead_code: true,
                    evaluate: true
                  }
                }
              }), new _webpack.default.DefinePlugin({
                'process.env.NODE_ENV': (0, _stringify.default)(dev ? 'development' : 'production')
              }), !dev && new _webpack.default.optimize.ModuleConcatenationPlugin(), isServer && new _pagesManifestPlugin.default(), !isServer && new _buildManifestPlugin.default(), !isServer && new _pagesPlugin.default(), !isServer && new _dynamicChunksPlugin.default(), isServer && new _nextjsSsrImport.default(), // In dev mode, we don't move anything to the commons bundle.
              // In production we move common modules into the existing main.js bundle
              !isServer && new _webpack.default.optimize.CommonsChunkPlugin({
                name: 'main.js',
                filename: dev ? 'static/commons/main.js' : 'static/commons/main-[chunkhash].js',
                minChunks: function minChunks(module, count) {
                  // React and React DOM are used everywhere in Next.js. So they should always be common. Even in development mode, to speed up compilation.
                  if (module.resource && module.resource.includes("".concat(_path.sep, "react-dom").concat(_path.sep)) && count >= 0) {
                    return true;
                  }

                  if (module.resource && module.resource.includes("".concat(_path.sep, "react").concat(_path.sep)) && count >= 0) {
                    return true;
                  } // In the dev we use on-demand-entries.
                  // So, it makes no sense to use commonChunks based on the minChunks count.
                  // Instead, we move all the code in node_modules into each of the pages.


                  if (dev) {
                    return false;
                  } // commons
                  // If there are one or two pages, only move modules to common if they are
                  // used in all of the pages. Otherwise, move modules used in at-least
                  // 1/2 of the total pages into commons.


                  if (totalPages <= 2) {
                    return count >= totalPages;
                  }

                  return count >= totalPages * 0.5; // commons end
                }
              }), // We use a manifest file in development to speed up HMR
              dev && !isServer && new _webpack.default.optimize.CommonsChunkPlugin({
                name: 'manifest.js',
                filename: dev ? 'static/commons/manifest.js' : 'static/commons/manifest-[chunkhash].js'
              })].filter(Boolean)
            };

            if (typeof config.webpack === 'function') {
              webpackConfig = config.webpack(webpackConfig, {
                dir: dir,
                dev: dev,
                isServer: isServer,
                buildId: buildId,
                config: config,
                defaultLoaders: defaultLoaders,
                totalPages: totalPages
              });
            }

            return _context2.abrupt("return", webpackConfig);

          case 12:
          case "end":
=======
=======
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b

var _toConsumableArray2 = require('babel-runtime/helpers/toConsumableArray');

var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _getIterator2 = require('babel-runtime/core-js/get-iterator');

var _getIterator3 = _interopRequireDefault(_getIterator2);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _map = require('babel-runtime/core-js/map');

var _map2 = _interopRequireDefault(_map);

var _path = require('path');

var _crypto = require('crypto');

var _webpack = require('webpack');

var _webpack2 = _interopRequireDefault(_webpack);

var _globPromise = require('glob-promise');

var _globPromise2 = _interopRequireDefault(_globPromise);

var _writeFileWebpackPlugin = require('write-file-webpack-plugin');

var _writeFileWebpackPlugin2 = _interopRequireDefault(_writeFileWebpackPlugin);

var _friendlyErrorsWebpackPlugin = require('friendly-errors-webpack-plugin');

var _friendlyErrorsWebpackPlugin2 = _interopRequireDefault(_friendlyErrorsWebpackPlugin);

var _caseSensitivePathsWebpackPlugin = require('case-sensitive-paths-webpack-plugin');

var _caseSensitivePathsWebpackPlugin2 = _interopRequireDefault(_caseSensitivePathsWebpackPlugin);

var _unlinkFilePlugin = require('./plugins/unlink-file-plugin');

var _unlinkFilePlugin2 = _interopRequireDefault(_unlinkFilePlugin);

var _pagesPlugin = require('./plugins/pages-plugin');

var _pagesPlugin2 = _interopRequireDefault(_pagesPlugin);

var _dynamicChunksPlugin = require('./plugins/dynamic-chunks-plugin');

var _dynamicChunksPlugin2 = _interopRequireDefault(_dynamicChunksPlugin);

var _combineAssetsPlugin = require('./plugins/combine-assets-plugin');

var _combineAssetsPlugin2 = _interopRequireDefault(_combineAssetsPlugin);

var _config = require('../config');

var _config2 = _interopRequireDefault(_config);

var _babelCore = require('babel-core');

var babelCore = _interopRequireWildcard(_babelCore);

var _findConfig = require('./babel/find-config');

var _findConfig2 = _interopRequireDefault(_findConfig);

var _rootModuleRelativePath = require('./root-module-relative-path');

var _rootModuleRelativePath2 = _interopRequireDefault(_rootModuleRelativePath);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var documentPage = (0, _path.join)('pages', '_document.js');
var defaultPages = ['_error.js', '_document.js'];
var nextPagesDir = (0, _path.join)(__dirname, '..', '..', 'pages');
var nextNodeModulesDir = (0, _path.join)(__dirname, '..', '..', '..', 'node_modules');
var interpolateNames = new _map2.default(defaultPages.map(function (p) {
  return [(0, _path.join)(nextPagesDir, p), 'dist/pages/' + p];
}));

var relativeResolve = (0, _rootModuleRelativePath2.default)(require);

exports.default = function () {
  var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2(dir) {
    var _this = this;

    var _ref2 = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},
        buildId = _ref2.buildId,
        _ref2$dev = _ref2.dev,
        dev = _ref2$dev === undefined ? false : _ref2$dev,
        _ref2$quiet = _ref2.quiet,
        quiet = _ref2$quiet === undefined ? false : _ref2$quiet,
        buildDir = _ref2.buildDir,
        _ref2$conf = _ref2.conf,
        conf = _ref2$conf === undefined ? null : _ref2$conf;

    var config, defaultEntries, mainJS, totalPages, entry, plugins, nodePathList, mainBabelOptions, externalBabelConfig, options, rules, webpackConfig;
    return _regenerator2.default.wrap(function _callee2$(_context2) {
      while (1) {
        switch (_context2.prev = _context2.next) {
          case 0:
            dir = (0, _path.resolve)(dir);
            config = (0, _config2.default)(dir, conf);
            defaultEntries = dev ? [(0, _path.join)(__dirname, '..', '..', 'client', 'webpack-hot-middleware-client'), (0, _path.join)(__dirname, '..', '..', 'client', 'on-demand-entries-client')] : [];
            mainJS = dev ? require.resolve('../../client/next-dev') : require.resolve('../../client/next');
            totalPages = void 0;

            entry = function () {
              var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee() {
                var entries, pages, devPages, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, p, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, _p, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, _p2, entryName;

                return _regenerator2.default.wrap(function _callee$(_context) {
                  while (1) {
                    switch (_context.prev = _context.next) {
                      case 0:
                        entries = {
                          'main.js': [].concat(defaultEntries, [mainJS])
                        };
                        _context.next = 3;
                        return (0, _globPromise2.default)('pages/**/*.js', { cwd: dir });

                      case 3:
                        pages = _context.sent;
                        devPages = pages.filter(function (p) {
                          return p === 'pages/_document.js' || p === 'pages/_error.js';
                        });

                        // In the dev environment, on-demand-entry-handler will take care of
                        // managing pages.

                        if (!dev) {
                          _context.next = 27;
                          break;
                        }

                        _iteratorNormalCompletion = true;
                        _didIteratorError = false;
                        _iteratorError = undefined;
                        _context.prev = 9;

                        for (_iterator = (0, _getIterator3.default)(devPages); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                          p = _step.value;

                          entries[(0, _path.join)('bundles', p)] = ['./' + p + '?entry'];
                        }
                        _context.next = 17;
                        break;

                      case 13:
                        _context.prev = 13;
                        _context.t0 = _context['catch'](9);
                        _didIteratorError = true;
                        _iteratorError = _context.t0;

                      case 17:
                        _context.prev = 17;
                        _context.prev = 18;

                        if (!_iteratorNormalCompletion && _iterator.return) {
                          _iterator.return();
                        }

                      case 20:
                        _context.prev = 20;

                        if (!_didIteratorError) {
                          _context.next = 23;
                          break;
                        }

                        throw _iteratorError;

                      case 23:
                        return _context.finish(20);

                      case 24:
                        return _context.finish(17);

                      case 25:
                        _context.next = 46;
                        break;

                      case 27:
                        _iteratorNormalCompletion2 = true;
                        _didIteratorError2 = false;
                        _iteratorError2 = undefined;
                        _context.prev = 30;

                        for (_iterator2 = (0, _getIterator3.default)(pages); !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
                          _p = _step2.value;

                          entries[(0, _path.join)('bundles', _p)] = ['./' + _p + '?entry'];
                        }
                        _context.next = 38;
                        break;

                      case 34:
                        _context.prev = 34;
                        _context.t1 = _context['catch'](30);
                        _didIteratorError2 = true;
                        _iteratorError2 = _context.t1;

                      case 38:
                        _context.prev = 38;
                        _context.prev = 39;

                        if (!_iteratorNormalCompletion2 && _iterator2.return) {
                          _iterator2.return();
                        }

                      case 41:
                        _context.prev = 41;

                        if (!_didIteratorError2) {
                          _context.next = 44;
                          break;
                        }

                        throw _iteratorError2;

                      case 44:
                        return _context.finish(41);

                      case 45:
                        return _context.finish(38);

                      case 46:
                        _iteratorNormalCompletion3 = true;
                        _didIteratorError3 = false;
                        _iteratorError3 = undefined;
                        _context.prev = 49;


                        for (_iterator3 = (0, _getIterator3.default)(defaultPages); !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
                          _p2 = _step3.value;
                          entryName = (0, _path.join)('bundles', 'pages', _p2);

                          if (!entries[entryName]) {
                            entries[entryName] = [(0, _path.join)(nextPagesDir, _p2) + '?entry'];
                          }
                        }

                        _context.next = 57;
                        break;

                      case 53:
                        _context.prev = 53;
                        _context.t2 = _context['catch'](49);
                        _didIteratorError3 = true;
                        _iteratorError3 = _context.t2;

                      case 57:
                        _context.prev = 57;
                        _context.prev = 58;

                        if (!_iteratorNormalCompletion3 && _iterator3.return) {
                          _iterator3.return();
                        }

                      case 60:
                        _context.prev = 60;

                        if (!_didIteratorError3) {
                          _context.next = 63;
                          break;
                        }

                        throw _iteratorError3;

                      case 63:
                        return _context.finish(60);

                      case 64:
                        return _context.finish(57);

                      case 65:
                        totalPages = pages.filter(function (p) {
                          return p !== documentPage;
                        }).length;

                        return _context.abrupt('return', entries);

                      case 67:
                      case 'end':
                        return _context.stop();
                    }
                  }
                }, _callee, _this, [[9, 13, 17, 25], [18,, 20, 24], [30, 34, 38, 46], [39,, 41, 45], [49, 53, 57, 65], [58,, 60, 64]]);
              }));

              return function entry() {
                return _ref3.apply(this, arguments);
              };
            }();

            plugins = [new _webpack2.default.IgnorePlugin(/(precomputed)/, /node_modules.+(elliptic)/), new _webpack2.default.LoaderOptionsPlugin({
              options: {
                context: dir,
                customInterpolateName: function customInterpolateName(url, name, opts) {
                  return interpolateNames.get(this.resourcePath) || url;
                }
              }
            }), new _writeFileWebpackPlugin2.default({
              exitOnErrors: false,
              log: false,
              // required not to cache removed files
              useHashIndex: false
            }), new _webpack2.default.optimize.CommonsChunkPlugin({
              name: 'commons',
              filename: 'commons.js',
              minChunks: function minChunks(module, count) {
                // We need to move react-dom explicitly into common chunks.
                // Otherwise, if some other page or module uses it, it might
                // included in that bundle too.
                if (module.context && module.context.indexOf(_path.sep + 'react-dom' + _path.sep) >= 0) {
                  return true;
                }

                // In the dev we use on-demand-entries.
                // So, it makes no sense to use commonChunks based on the minChunks count.
                // Instead, we move all the code in node_modules into each of the pages.
                if (dev) {
                  return false;
                }

                // If there are one or two pages, only move modules to common if they are
                // used in all of the pages. Otherwise, move modules used in at-least
                // 1/2 of the total pages into commons.
                if (totalPages <= 2) {
                  return count >= totalPages;
                }
                return count >= totalPages * 0.5;
              }
            }),
            // This chunk contains all the webpack related code. So, all the changes
            // related to that happens to this chunk.
            // It won't touch commons.js and that gives us much better re-build perf.
            new _webpack2.default.optimize.CommonsChunkPlugin({
              name: 'manifest',
              filename: 'manifest.js'
            }), new _webpack2.default.DefinePlugin({
              'process.env.NODE_ENV': (0, _stringify2.default)(dev ? 'development' : 'production')
            }), new _pagesPlugin2.default(), new _dynamicChunksPlugin2.default(), new _caseSensitivePathsWebpackPlugin2.default()];


            if (dev) {
              plugins.push(new _webpack2.default.HotModuleReplacementPlugin(), new _webpack2.default.NoEmitOnErrorsPlugin(), new _unlinkFilePlugin2.default());
              if (!quiet) {
                plugins.push(new _friendlyErrorsWebpackPlugin2.default());
              }
            } else {
              plugins.push(new _webpack2.default.IgnorePlugin(/react-hot-loader/));
              plugins.push(new _combineAssetsPlugin2.default({
                input: ['manifest.js', 'commons.js', 'main.js'],
                output: 'app.js'
              }), new _webpack2.default.optimize.UglifyJsPlugin({
                compress: { warnings: false },
                sourceMap: false
              }));
              plugins.push(new _webpack2.default.optimize.ModuleConcatenationPlugin());
            }

            nodePathList = (process.env.NODE_PATH || '').split(process.platform === 'win32' ? ';' : ':').filter(function (p) {
              return !!p;
            });
            mainBabelOptions = {
              cacheDirectory: true,
              presets: []
            };
            externalBabelConfig = (0, _findConfig2.default)(dir);

            if (externalBabelConfig) {
              console.log('> Using external babel configuration');
              console.log('> Location: "' + externalBabelConfig.loc + '"');
              // It's possible to turn off babelrc support via babelrc itself.
              // In that case, we should add our default preset.
              // That's why we need to do this.
              options = externalBabelConfig.options;

              mainBabelOptions.babelrc = options.babelrc !== false;
            } else {
              mainBabelOptions.babelrc = false;
            }

            // Add our default preset if the no "babelrc" found.
            if (!mainBabelOptions.babelrc) {
              mainBabelOptions.presets.push(require.resolve('./babel/preset'));
            }

            rules = (dev ? [{
              test: /\.js(\?[^?]*)?$/,
              loader: 'hot-self-accept-loader',
              include: [(0, _path.join)(dir, 'pages'), nextPagesDir]
            }, {
              test: /\.js(\?[^?]*)?$/,
              loader: 'react-hot-loader/webpack',
              exclude: /node_modules/
            }] : []).concat([{
              test: /\.json$/,
              loader: 'json-loader'
            }, {
              test: /\.(js|json)(\?[^?]*)?$/,
              loader: 'emit-file-loader',
              include: [dir, nextPagesDir],
              exclude: function exclude(str) {
                return (/node_modules/.test(str) && str.indexOf(nextPagesDir) !== 0
                );
              },

              options: {
                name: 'dist/[path][name].[ext]',
                // By default, our babel config does not transpile ES2015 module syntax because
                // webpack knows how to handle them. (That's how it can do tree-shaking)
                // But Node.js doesn't know how to handle them. So, we have to transpile them here.
                transform: function transform(_ref4) {
                  var content = _ref4.content,
                      sourceMap = _ref4.sourceMap,
                      interpolatedName = _ref4.interpolatedName;

                  // Only handle .js files
                  if (!/\.js$/.test(interpolatedName)) {
                    return { content: content, sourceMap: sourceMap };
                  }

                  var transpiled = babelCore.transform(content, {
                    babelrc: false,
                    sourceMaps: dev ? 'both' : false,
                    // Here we need to resolve all modules to the absolute paths.
                    // Earlier we did it with the babel-preset.
                    // But since we don't transpile ES2015 in the preset this is not resolving.
                    // That's why we need to do it here.
                    // See more: https://github.com/zeit/next.js/issues/951
                    plugins: [[require.resolve('babel-plugin-transform-es2015-modules-commonjs')], [require.resolve('babel-plugin-module-resolver'), {
                      alias: {
                        'babel-runtime': relativeResolve('babel-runtime/package'),
                        'next/link': relativeResolve('../../lib/link'),
                        'next/prefetch': relativeResolve('../../lib/prefetch'),
                        'next/css': relativeResolve('../../lib/css'),
                        'next/dynamic': relativeResolve('../../lib/dynamic'),
                        'next/head': relativeResolve('../../lib/head'),
                        'next/document': relativeResolve('../../server/document'),
                        'next/router': relativeResolve('../../lib/router'),
                        'next/error': relativeResolve('../../lib/error'),
                        'styled-jsx/style': relativeResolve('styled-jsx/style')
                      }
                    }]],
                    inputSourceMap: sourceMap
                  });

                  // Strip ?entry to map back to filesystem and work with iTerm, etc.
                  var map = transpiled.map;

                  var output = transpiled.code;

                  if (map) {
                    var nodeMap = (0, _assign2.default)({}, map);
                    nodeMap.sources = nodeMap.sources.map(function (source) {
                      return source.replace(/\?entry/, '');
                    });
                    delete nodeMap.sourcesContent;

                    // Output explicit inline source map that source-map-support can pickup via requireHook mode.
                    // Since these are not formal chunks, the devtool infrastructure in webpack does not output
                    // a source map for these files.
                    var sourceMapUrl = new Buffer((0, _stringify2.default)(nodeMap), 'utf-8').toString('base64');
                    output = output + '\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,' + sourceMapUrl;
                  }

                  return {
                    content: output,
                    sourceMap: transpiled.map
                  };
                }
              }
            }, {
              loader: 'babel-loader',
              include: nextPagesDir,
              exclude: function exclude(str) {
                return (/node_modules/.test(str) && str.indexOf(nextPagesDir) !== 0
                );
              },

              options: {
                babelrc: false,
                cacheDirectory: true,
                presets: [require.resolve('./babel/preset')]
              }
            }, {
              test: /\.js(\?[^?]*)?$/,
              loader: 'babel-loader',
              include: [dir],
              exclude: function exclude(str) {
                return (/node_modules/.test(str)
                );
              },

              options: mainBabelOptions
            }]);
            webpackConfig = {
              context: dir,
              entry: entry,
              output: {
                path: buildDir ? (0, _path.join)(buildDir, '.next') : (0, _path.join)(dir, config.distDir),
                filename: '[name]',
                libraryTarget: 'commonjs2',
                publicPath: '/_next/' + buildId + '/webpack/',
                strictModuleExceptionHandling: true,
                devtoolModuleFilenameTemplate: function devtoolModuleFilenameTemplate(_ref5) {
                  var resourcePath = _ref5.resourcePath;

                  var hash = (0, _crypto.createHash)('sha1');
                  hash.update(Date.now() + '');
                  var id = hash.digest('hex').slice(0, 7);

                  // append hash id for cache busting
                  return 'webpack:///' + resourcePath + '?' + id;
                },

                // This saves chunks with the name given via require.ensure()
                chunkFilename: '[name]'
              },
              resolve: {
                modules: [nextNodeModulesDir, 'node_modules'].concat((0, _toConsumableArray3.default)(nodePathList))
              },
              resolveLoader: {
                modules: [nextNodeModulesDir, 'node_modules', (0, _path.join)(__dirname, 'loaders')].concat((0, _toConsumableArray3.default)(nodePathList))
              },
              plugins: plugins,
              module: {
                rules: rules
              },
              devtool: dev ? 'cheap-module-inline-source-map' : false,
              performance: { hints: false }
            };

            if (!config.webpack) {
              _context2.next = 20;
              break;
            }

            console.log('> Using "webpack" config function defined in ' + config.configOrigin + '.');
            _context2.next = 19;
            return config.webpack(webpackConfig, { buildId: buildId, dev: dev });

          case 19:
            webpackConfig = _context2.sent;

          case 20:
            return _context2.abrupt('return', (0, _webpack2.default)(webpackConfig));

          case 21:
          case 'end':
<<<<<<< HEAD
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
=======
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
            return _context2.stop();
        }
      }
    }, _callee2, this);
  }));
<<<<<<< HEAD
<<<<<<< HEAD
  return _getBaseWebpackConfig.apply(this, arguments);
}
=======
=======
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b

  function createCompiler(_x2) {
    return _ref.apply(this, arguments);
  }

  return createCompiler;
<<<<<<< HEAD
}();
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
=======
}();
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
