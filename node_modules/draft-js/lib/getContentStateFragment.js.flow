/**
 * Copyright (c) 2013-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * @providesModule getContentStateFragment
<<<<<<< HEAD
<<<<<<< HEAD
 * @format
=======
 * @typechecks
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
=======
 * @typechecks
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
 * @flow
 */

'use strict';

import type { BlockMap } from './BlockMap';
import type ContentState from './ContentState';
import type SelectionState from './SelectionState';

<<<<<<< HEAD
<<<<<<< HEAD
const randomizeBlockMapKeys = require('./randomizeBlockMapKeys');
const removeEntitiesAtEdges = require('./removeEntitiesAtEdges');

const getContentStateFragment = (contentState: ContentState, selectionState: SelectionState): BlockMap => {
  const startKey = selectionState.getStartKey();
  const startOffset = selectionState.getStartOffset();
  const endKey = selectionState.getEndKey();
  const endOffset = selectionState.getEndOffset();
=======
=======
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
var generateRandomKey = require('./generateRandomKey');
var removeEntitiesAtEdges = require('./removeEntitiesAtEdges');

function getContentStateFragment(contentState: ContentState, selectionState: SelectionState): BlockMap {
  var startKey = selectionState.getStartKey();
  var startOffset = selectionState.getStartOffset();
  var endKey = selectionState.getEndKey();
  var endOffset = selectionState.getEndOffset();
<<<<<<< HEAD
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
=======
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b

  // Edge entities should be stripped to ensure that we don't preserve
  // invalid partial entities when the fragment is reused. We do, however,
  // preserve entities that are entirely within the selection range.
<<<<<<< HEAD
<<<<<<< HEAD
  const contentWithoutEdgeEntities = removeEntitiesAtEdges(contentState, selectionState);

  const blockMap = contentWithoutEdgeEntities.getBlockMap();
  const blockKeys = blockMap.keySeq();
  const startIndex = blockKeys.indexOf(startKey);
  const endIndex = blockKeys.indexOf(endKey) + 1;

  return randomizeBlockMapKeys(blockMap.slice(startIndex, endIndex).map((block, blockKey) => {
    const text = block.getText();
    const chars = block.getCharacterList();

    if (startKey === endKey) {
      return block.merge({
=======
=======
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
  var contentWithoutEdgeEntities = removeEntitiesAtEdges(contentState, selectionState);

  var blockMap = contentWithoutEdgeEntities.getBlockMap();
  var blockKeys = blockMap.keySeq();
  var startIndex = blockKeys.indexOf(startKey);
  var endIndex = blockKeys.indexOf(endKey) + 1;

  var slice = blockMap.slice(startIndex, endIndex).map((block, blockKey) => {
    var newKey = generateRandomKey();

    var text = block.getText();
    var chars = block.getCharacterList();

    if (startKey === endKey) {
      return block.merge({
        key: newKey,
<<<<<<< HEAD
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
=======
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
        text: text.slice(startOffset, endOffset),
        characterList: chars.slice(startOffset, endOffset)
      });
    }

    if (blockKey === startKey) {
      return block.merge({
<<<<<<< HEAD
<<<<<<< HEAD
=======
        key: newKey,
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
=======
        key: newKey,
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
        text: text.slice(startOffset),
        characterList: chars.slice(startOffset)
      });
    }

    if (blockKey === endKey) {
      return block.merge({
<<<<<<< HEAD
<<<<<<< HEAD
=======
        key: newKey,
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
=======
        key: newKey,
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
        text: text.slice(0, endOffset),
        characterList: chars.slice(0, endOffset)
      });
    }

<<<<<<< HEAD
<<<<<<< HEAD
    return block;
  }));
};
=======
=======
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
    return block.set('key', newKey);
  });

  return slice.toOrderedMap();
}
<<<<<<< HEAD
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b
=======
>>>>>>> 3e7cc9eba236ff5c5205c34bae31be88b995768b

module.exports = getContentStateFragment;